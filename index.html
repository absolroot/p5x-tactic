<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>페르소나5X 택틱</title>
  <link rel="icon" type="image/x-icon" href="./img/ui/favicon.ico">
  <link rel="stylesheet" href="./styles.css">

  <!-- Google Analytics 추적 코드 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SJ93CPWQPE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SJ93CPWQPE'); 
  </script>

  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <!-- 데이터 파일들 -->
    <script src="./data/characters.js"></script>
    <script src="./data/revelations.js"></script>
    <script src="./data/rituals.js"></script>
    <script src="./data/weapons.js"></script>
    <script src="./data/persona.js"></script>
    <script src="./data/skills.js"></script>
    <!-- 공유/가져오기/내보내기 데이터 처리 함수 -->
    <script src="./js/share.js"></script>
    <script src="./js/import.js"></script>
    <script src="./js/export.js"></script>
    <!-- 기본 설정 함수 -->
    <script src="./js/setparty.js"></script>
    <script src="./js/setwonder.js"></script>
    <!-- 파티 이미지 함수 -->
    <script src="./js/partyimg.js"></script>
    <!-- 액션 생성 함수 -->
    <script src="./js/createAction.js"></script>
    <!-- 턴 렌더링 함수 -->
    <script src="./js/renderTurns.js"></script>
    <!-- 자동 액션 업데이트 함수 -->
    <script src="./js/updateAuto.js"></script>
    <!-- 의식 별 행동패턴 찾기 -->
    <script src="./js/findPattern.js"></script>
    <!-- 시뮬레이터 관련 함수 -->
    <script src="./js/simulator.js"></script>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="logo-container"> <!-- 현재 페이지로 하이퍼링크 걸기 -->
        <a href="./index.html">
          <img src="./img/logo/P5Xlogo.png" alt="Persona5X Logo" />
        </a>
        <div style="display: flex; align-items: center;">
          <input type="text" 
                 class="title-input" 
                 value="페르소나5X 택틱 메이커" 
                 style="color: white;">
        </div>
      </div>
      <div class="top-buttons">
        <button class="export-import-btn" onclick="exportData()">내보내기</button>
        <button class="export-import-btn" onclick="importData()">가져오기</button>
        <button class="export-import-btn" onclick="handleShare()">공유하기</button>
        <button class="export-import-btn toggle-ui-btn" onclick="toggleUI()"></button>
      </div>
    </div>
    
    <!-- 탭 버튼 추가 (header-container 아래) 시뮬레이터 개발중-->

    <div class="tab-container">
      <button class="tab-button active" data-tab="tactic">택틱 설정</button>
      <button class="tab-button" data-tab="simulator">시뮬레이터</button>
    </div>

    <!-- 탭 컨텐츠 영역 -->
    <div class="tab-content">
      <!-- 택틱 설정 탭 -->
      <div id="tactic" class="tab-pane active">
        <!-- 상단 컨테이너: (1) 원더 설정, (2) 파티 선택 -->
        <div id="top-container">
          <!-- 원더 설정 카드 -->
          <div class="card wonder-setting" id="wonder-config">
            <h2>원더 설정</h2>
            <div class="weapon-container">
              <label>무기
                <input type="text" class="wonder-weapon-input" list="weapon-list" placeholder="선택 또는 입력" />
              </label>
              <datalist id="weapon-list">
                <!-- JavaScript에서 동적으로 채워짐 -->
              </datalist>
            </div>
            <div class="persona-container">
              <label>페르소나1
                <input type="text" class="wonder-persona-input" data-persona-index="0" />
              </label>
              <div class="skill-inputs">
                <input type="text" class="persona-skill-input" data-persona-index="0" data-skill-slot="0" list="persona-skills-list" placeholder="고유스킬" />
                <input type="text" class="persona-skill-input" data-persona-index="0" data-skill-slot="1" list="persona-skills-list" placeholder="스킬 2" />
                <input type="text" class="persona-skill-input" data-persona-index="0" data-skill-slot="2" list="persona-skills-list" placeholder="스킬 3" />
              </div>
            </div>
            <div class="persona-container">
              <label>페르소나2
                <input type="text" class="wonder-persona-input" data-persona-index="1" />
              </label>
              <div class="skill-inputs">
                <input type="text" class="persona-skill-input" data-persona-index="1" data-skill-slot="0" list="persona-skills-list" placeholder="고유스킬" />
                <input type="text" class="persona-skill-input" data-persona-index="1" data-skill-slot="1" list="persona-skills-list" placeholder="스킬 2" />
                <input type="text" class="persona-skill-input" data-persona-index="1" data-skill-slot="2" list="persona-skills-list" placeholder="스킬 3" />
              </div>
            </div>
            <div class="persona-container">
              <label>페르소나3
                <input type="text" class="wonder-persona-input" data-persona-index="2" />
              </label>
              <div class="skill-inputs">
                <input type="text" class="persona-skill-input" data-persona-index="2" data-skill-slot="0" list="persona-skills-list" placeholder="고유스킬" />
                <input type="text" class="persona-skill-input" data-persona-index="2" data-skill-slot="1" list="persona-skills-list" placeholder="스킬 2" />
                <input type="text" class="persona-skill-input" data-persona-index="2" data-skill-slot="2" list="persona-skills-list" placeholder="스킬 3" />
              </div>
            </div>
          </div>
          
          <!-- 파티 선택 카드 -->
          <div class="card" id="party-selection">
            <h2>괴도단</h2>
            <div class="party-member" data-index="0">
              <div class="input-group">
                <label>괴도 1</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>의식:</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>순서:</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="input-group">
                <label>주 계시:</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>일월성진:</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="1">
              <div class="input-group">
                <label>괴도 2</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>의식:</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>순서:</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="input-group">
                <label>주 계시:</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>일월성진:</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="2">
              <div class="input-group">
                <label>괴도 3</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>의식:</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>순서:</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="input-group">
                <label>주 계시:</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>일월성진:</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="3">
              <div class="input-group">
                <label>괴도 4</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>의식:</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>순서:</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4" selected>4</option>
                </select>
              </div>
              <div class="input-group">
                <label>주 계시:</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>일월성진:</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="4">
              <div class="input-group">
                <label>해명 -</label>
                <select class="party-name">
                  <option value="">-</option>
                  <!-- supportParty 목록은 JavaScript에서 동적으로 채워짐 -->
                </select>
              </div>
              <div class="input-group">
                <label>의식:</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>순서:</label>
                <select class="party-order" style="width: 50px;">
                  <option value="-" selected>-</option>
                </select>
              </div>
              <div class="input-group">
                <label>주 계시:</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>일월성진:</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 파티 이미지를 위한 컨테이너 -->
        <div class = "middle-contianer">
          <div class="party-images-container">
            <div class="party-images"></div>
          </div>
          <div class="madeby">absolroot.github.io/p5x-tactic by 루트</div>
        </div>

        <!-- 턴 영역 (6턴) -->
        <div class="mobile-buttons">
          <button class="mobile-lock-btn" onclick="toggleTurnsLock()">턴 잠금</button>
          <button class="toggle-ui-btn" onclick="toggleUI()">UI 숨김</button>
        </div>
        <div id="turns">
          <!-- 기존 턴 컨텐츠 -->
        </div>
      </div>

      <!-- 시뮬레이터 탭 -->
      <div id="simulator" class="tab-pane">
        <div class="simulator-container">
          <!-- 턴 목록 -->
          <div class="turn-list">
            <!-- 턴별 행동 목록은 JS로 동적 생성 -->
          </div>
          <!-- 상태 효과 영역 -->
          <div class="status-container">
            <div class="buff-container">
              <h3>아군 버프</h3>
              <div class="buff-list">
                <!-- 버프 목록은 JS로 동적 생성 -->
              </div>
            </div>
            <div class="debuff-container">
              <h3>적 디버프</h3>
              <div class="debuff-list">
                <!-- 디버프 목록은 JS로 동적 생성 -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SortableJS (드래그앤드롭 라이브러리) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
      /* ========== 전역 데이터 ========== */
      // 원더의 페르소나 3칸
      let wonderPersonas = ["","",""];
      
      // 파티원 정보 (5명)
      let partyMembers = [
        { index: 0, name: "원더", order: "1", ritual: "" },
        { index: 1, name: "", order: "2", ritual: "" },
        { index: 2, name: "", order: "3", ritual: "" },
        { index: 3, name: "", order: "4", ritual: "" },
        { index: 4, name: "", order: "-", ritual: "" }
      ];
      
      // 턴 데이터(6턴). 각 턴에는 actions 배열(자동+수동 구분)만 둔다.
      let turns = [];
      for (let i = 0; i < 6; i++) {
        turns.push({
          turn: i + 1,
          actions: [
            /* 예: { type: 'auto', character: '원더', action: '', wonderPersona: '' } */
          ]
        });
      }


      
      // DOM이 로드되면 초기 설정
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const sharedData = urlParams.get('data');
        
        if (sharedData) {
          const decodedData = processSharedData(sharedData);

          console.log(decodedData);

          if (decodedData) {
            // 제목 설정 추가
            document.querySelector('.title-input').value = decodedData.title;
            
            // 원더 페르소나 데이터 설정
            wonderPersonas = decodedData.w;
            
            // 원더 페르소나 데이터 설정
            const wonderInputs = document.querySelectorAll(".wonder-persona-input");
            wonderInputs.forEach((input, idx) => {
              input.value = wonderPersonas[idx] || "";
            });

            // 원더 무기 설정
            document.querySelector(".wonder-weapon-input").value = decodedData.weapon;

            // 페르소나 스킬 설정
            const skillInputs = document.querySelectorAll(".persona-skill-input");
            let normalSkillIndex = 0;  // 일반 스킬 인덱스

            skillInputs.forEach((input, index) => {
                // 고유 스킬 슬롯
                if (index % 3 === 0) {
                    const personaIndex = Math.floor(index / 3);
                    const selectedPersona = decodedData.w[personaIndex];
                    if (selectedPersona && personaData[selectedPersona]) {
                        input.value = personaData[selectedPersona].uniqueSkill.name;
                        input.disabled = true;
                        input.classList.add('unique-skill');
                    }
                } 
                // 일반 스킬 슬롯
                else {
                    if (decodedData.personaSkills[normalSkillIndex]) {
                        input.value = decodedData.personaSkills[normalSkillIndex];
                    }
                    normalSkillIndex++;
                }
            });
            
            // partyMembers 데이터 복원
            decodedData.p.forEach((p, idx) => {
              partyMembers[idx].name = p.name;
              partyMembers[idx].order = p.order;
              partyMembers[idx].ritual = p.ritual;
              
              // 파티원 이름 입력 필드 업데이트
              const partyDiv = document.querySelector(`.party-member[data-index="${idx}"]`);
              if (partyDiv) {
                const nameInput = partyDiv.querySelector(".party-name-input");
                const orderSelect = partyDiv.querySelector(".party-order");
                const ritualSelect = partyDiv.querySelector(".party-ritual");
                const mainRevSelect = partyDiv.querySelector(".main-revelation");
                const subRevSelect = partyDiv.querySelector(".sub-revelation");
                
                if (nameInput) nameInput.value = p.name || "";
                if (orderSelect) orderSelect.value = p.order || "";
                if (ritualSelect) ritualSelect.value = p.ritual || "0";
                
                // 계시 설정
                if (mainRevSelect && p.mainRev) {
                  mainRevSelect.value = p.mainRev;
                  // 주 계시가 선택되었을 때 일월성진 활성화
                  if (p.mainRev && revelationData.main[p.mainRev]) {
                    subRevSelect.disabled = false;
                    // 일월성진 옵션 설정
                    subRevSelect.innerHTML = '<option value="">-</option>';
                    revelationData.main[p.mainRev].forEach(subRev => {
                      const opt = document.createElement("option");
                      opt.value = subRev;
                      opt.textContent = subRev;
                      subRevSelect.appendChild(opt);
                    });
                    // 일월성진 값 설정
                    if (p.subRev) {
                      subRevSelect.value = p.subRev;
                    }
                  }
                }
                
                // 원더일 경우 의식과 계시 비활성화
                if (p.n === "원더") {
                  if (ritualSelect) {
                    ritualSelect.disabled = true;
                    ritualSelect.value = "0";
                  }
                  if (mainRevSelect) mainRevSelect.disabled = true;
                  if (subRevSelect) subRevSelect.disabled = true;
                }
              }
            });
            
            // 턴 데이터 복원
            turns = decodedData.t;
            
            // UI 기본 설정
            setupWonderConfig();
            setupPartySelection();

            // 계시값 재설정
            decodedData.p.forEach((p, idx) => {
              const partyDiv = document.querySelector(`.party-member[data-index="${idx}"]`);
              if (partyDiv && p.mainRev) {
                const mainRevSelect = partyDiv.querySelector(".main-revelation");
                const subRevSelect = partyDiv.querySelector(".sub-revelation");
                
                if (mainRevSelect) {
                  mainRevSelect.value = p.mainRev;
                  
                  if (revelationData.main[p.mainRev]) {
                    subRevSelect.disabled = false;
                    subRevSelect.innerHTML = '<option value="">-</option>';
                    revelationData.main[p.mainRev].forEach(subRev => {
                      const opt = document.createElement("option");
                      opt.value = subRev;
                      opt.textContent = subRev;
                      subRevSelect.appendChild(opt);
                    });
                    
                    if (p.subRev) {
                      subRevSelect.value = p.subRev;
                    }
                  }
                }
              }
            });

            updatePartyImages();
            
            // 턴 렌더링 (자동 액션 업데이트 전)
            renderTurns();
            
            // 각 턴의 액션 데이터 복원
            turns.forEach((turn, turnIndex) => {
              const turnContainer = document.querySelector(`.turn-container[data-turn-index="${turnIndex}"]`);
              if (!turnContainer) return;

              const actionsList = turnContainer.querySelector('.actions');
              if (!actionsList) return;

              turn.actions.forEach((action, actionIndex) => {
                const actionItem = actionsList.children[actionIndex]; 
                if (!actionItem) return;

                // 캐릭터 선택
                const charSelect = actionItem.querySelector('.action-character');
                if (charSelect) {
                  charSelect.value = action.character;
                }

                // 원더 페르소나 또는 스킬 선택
                if (action.character === "원더") {
                  const personaSelect = actionItem.querySelector('.wonder-persona-select');
                  if (personaSelect) {
                    personaSelect.value = action.wonderPersona;
                  }
                } else {
                  const skillSelect = actionItem.querySelector('.action-skill');
                  if (skillSelect) {
                    skillSelect.value = action.action;
                  }
                }

                // 메모 입력
                const memoInput = actionItem.querySelector('.action-memo');
                if (memoInput) {
                  memoInput.value = action.memo || "";
                }
              });
            });
            
            // 마지막으로 자동 액션 업데이트
            updateAutoActions();
            
          } 
        } else {
          setupWonderConfig();
          setupPartySelection();
          updateAutoActions();
          updatePartyImages();
          renderTurns();
        }

        // datalist에 스킬 목록 추가
        const skillsList = document.getElementById('persona-skills-list');
        
        // personaSkillList의 모든 스킬을 option으로 추가
        Object.keys(personaSkillList).forEach(skillName => {
          const option = document.createElement('option');
          option.value = skillName;
          skillsList.appendChild(option);
        });

        // 검색 가능한 드롭다운 요소들 선택
        const searchableInputs = document.querySelectorAll('input[list]');
        
        searchableInputs.forEach(input => {
          // mousedown 이벤트로 드롭다운 화살표 클릭 처리
          input.addEventListener('mousedown', function(e) {
            // 드롭다운 화살표 클릭 감지 (입력 필드의 오른쪽 20px 영역)
            if (e.offsetX > this.offsetWidth - 20) {
              // 값을 비우고 포커스 유지
              this.value = '';
            }
          });
        });
      });


      // 기본 URL 함수
      function getBaseUrl() {
        // 현재 페이지의 기본 URL을 반환 (쿼리 파라미터 제외)
        return window.location.href.split('?')[0];
      }


      // UI 토글 함수
      function toggleUI() {
        const container = document.querySelector('.container');
        const desktopToggleBtn = document.querySelector('.header-container .toggle-ui-btn');
        const mobileToggleBtn = document.querySelector('.mobile-buttons .toggle-ui-btn');
        
        container.classList.toggle('hide-ui');
        
        // 데스크톱과 모바일 버튼 모두 처리
        if (desktopToggleBtn) desktopToggleBtn.classList.toggle('active');
        if (mobileToggleBtn) mobileToggleBtn.classList.toggle('active');
        
        // 토글 상태 저장
        localStorage.setItem('uiHidden', container.classList.contains('hide-ui'));
      }

      // 페이지 로드 시 이전 상태 복원
      document.addEventListener('DOMContentLoaded', () => {
        const uiHidden = localStorage.getItem('uiHidden') === 'true';
        const desktopToggleBtn = document.querySelector('.header-container .toggle-ui-btn');
        const mobileToggleBtn = document.querySelector('.mobile-buttons .toggle-ui-btn');
        
        if (uiHidden) {
          document.querySelector('.container').classList.add('hide-ui');
          if (desktopToggleBtn) desktopToggleBtn.classList.add('active');
          if (mobileToggleBtn) mobileToggleBtn.classList.add('active');
        }
      });

      function toggleTurnsLock() {
        const lockBtn = document.querySelector('.mobile-lock-btn');
        const turnsContainer = document.getElementById('turns');
        
        lockBtn.classList.toggle('active');
        turnsContainer.classList.toggle('turns-locked');
        
        // 잠금 상태 저장
        localStorage.setItem('turnsLocked', turnsContainer.classList.contains('turns-locked'));
      }

      // 페이지 로드 시 이전 잠금 상태 복원
      document.addEventListener('DOMContentLoaded', () => {
        const turnsLocked = localStorage.getItem('turnsLocked') === 'true';
        if (turnsLocked) {
          const lockBtn = document.querySelector('.mobile-lock-btn');
          const turnsContainer = document.getElementById('turns');
          
          lockBtn.classList.add('active');
          turnsContainer.classList.add('turns-locked');
        }
      });


    </script>
  </div>

  <!-- datalist 추가 (body 태그 안, container div 안에) -->
  <datalist id="persona-skills-list">
    <!-- JavaScript에서 동적으로 채워질 예정 -->
  </datalist>
</body>
</html>
