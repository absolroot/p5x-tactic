<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>페르소나5X 택틱</title>
  <link rel="icon" type="image/x-icon" href="./img/ui/favicon.ico">
  <link rel="stylesheet" href="./styles.css">

  <!-- Google Analytics 추적 코드 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SJ93CPWQPE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SJ93CPWQPE'); 
  </script>

  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <!-- 데이터 파일들 -->
    <script src="./data/characters.js"></script>
    <script src="./data/revelations.js"></script>
    <script src="./data/rituals.js"></script>
    <script src="./data/weapons.js"></script>
    <script src="./data/persona.js"></script>
    <script src="./data/skills.js"></script>
    <!-- 공유/가져오기/내보내기 데이터 처리 함수 -->
    <script src="./js/share.js"></script>
    <script src="./js/import.js"></script>
    <script src="./js/export.js"></script>
    <!-- 기본 설정 함수 -->
    <script src="./js/setparty.js"></script>
    <script src="./js/setwonder.js"></script>
    <!-- 파티 이미지 함수 -->
    <script src="./js/partyimg.js"></script>
    <!-- 액션 생성 함수 -->
    <script src="./js/createAction.js"></script>
    <!-- 턴 렌더링 함수 -->
    <script src="./js/renderTurns.js"></script>
    <!-- 자동 액션 업데이트 함수 -->
    <script src="./js/updateAuto.js"></script>
    <!-- 의식 별 행동패턴 찾기 -->
    <script src="./js/findPattern.js"></script>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="logo-container"> <!-- 현재 페이지로 하이퍼링크 걸기 -->
        <a href="./index.html">
          <img src="./img/logo/P5Xlogo.png" alt="Persona5X Logo" />
        </a>
        <div style="display: flex; align-items: center;">
          <input type="text" 
                 class="title-input" 
                 value="페르소나5X 택틱 메이커" 
                 style="color: white;">
        </div>
      </div>
      <div class="top-buttons">
        <button class="export-import-btn" onclick="exportData()">내보내기</button>
        <button class="export-import-btn" onclick="importData()">가져오기</button>
        <button class="export-import-btn" onclick="handleShare()">공유하기</button>
        <button class="export-import-btn toggle-ui-btn" onclick="toggleUI()"></button>
      </div>
    </div>
    
    <!-- 상단 컨테이너: (1) 원더 설정, (2) 파티 선택 -->
    <div id="top-container">
      <!-- 원더 설정 카드 -->
      <div class="card wonder-setting" id="wonder-config">
        <h2>원더 설정</h2>
        <div class="weapon-container">
          <label>무기:
            <input type="text" class="wonder-weapon-input" list="weapon-list" placeholder="선택 또는 입력" />
          </label>
          <datalist id="weapon-list">
            <!-- JavaScript에서 동적으로 채워짐 -->
          </datalist>
        </div>
        <div class="persona-container">
          <label>페르소나1:
            <input type="text" class="wonder-persona-input" data-persona-index="0" />
          </label>
          <input type="text" class="persona-skill-input" data-persona-index="0" placeholder="스킬 세팅" />
        </div>
        <div class="persona-container">
          <label>페르소나2:
            <input type="text" class="wonder-persona-input" data-persona-index="1" />
          </label>
          <input type="text" class="persona-skill-input" data-persona-index="1" placeholder="스킬 세팅" />
        </div>
        <div class="persona-container">
          <label>페르소나3:
            <input type="text" class="wonder-persona-input" data-persona-index="2" />
          </label>
          <input type="text" class="persona-skill-input" data-persona-index="2" placeholder="스킬 세팅" />
        </div>
      </div>
      
      <!-- 파티 선택 카드 -->
      <div class="card" id="party-selection">
        <h2>괴도단</h2>
        <div class="party-member" data-index="0">
          <div class="input-group">
            <label>괴도 1</label>
            <select class="party-name">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>의식:</label>
            <select class="party-ritual" style="width: 50px;">
              <option value="0" selected>0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div class="input-group">
            <label>순서:</label>
            <select class="party-order" style="width: 50px;">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div class="input-group">
            <label>주 계시:</label>
            <select class="main-revelation">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>일월성진:</label>
            <select class="sub-revelation" disabled>
              <option value="">-</option>
            </select>
          </div>
        </div>
        <div class="party-member" data-index="1">
          <div class="input-group">
            <label>괴도 2</label>
            <select class="party-name">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>의식:</label>
            <select class="party-ritual" style="width: 50px;">
              <option value="0" selected>0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div class="input-group">
            <label>순서:</label>
            <select class="party-order" style="width: 50px;">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div class="input-group">
            <label>주 계시:</label>
            <select class="main-revelation">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>일월성진:</label>
            <select class="sub-revelation" disabled>
              <option value="">-</option>
            </select>
          </div>
        </div>
        <div class="party-member" data-index="2">
          <div class="input-group">
            <label>괴도 3</label>
            <select class="party-name">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>의식:</label>
            <select class="party-ritual" style="width: 50px;">
              <option value="0" selected>0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div class="input-group">
            <label>순서:</label>
            <select class="party-order" style="width: 50px;">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div class="input-group">
            <label>주 계시:</label>
            <select class="main-revelation">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>일월성진:</label>
            <select class="sub-revelation" disabled>
              <option value="">-</option>
            </select>
          </div>
        </div>
        <div class="party-member" data-index="3">
          <div class="input-group">
            <label>괴도 4</label>
            <select class="party-name">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>의식:</label>
            <select class="party-ritual" style="width: 50px;">
              <option value="0" selected>0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div class="input-group">
            <label>순서:</label>
            <select class="party-order" style="width: 50px;">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4" selected>4</option>
            </select>
          </div>
          <div class="input-group">
            <label>주 계시:</label>
            <select class="main-revelation">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>일월성진:</label>
            <select class="sub-revelation" disabled>
              <option value="">-</option>
            </select>
          </div>
        </div>
        <div class="party-member" data-index="4">
          <div class="input-group">
            <label>해명 -</label>
            <select class="party-name">
              <option value="">-</option>
              <!-- supportParty 목록은 JavaScript에서 동적으로 채워짐 -->
            </select>
          </div>
          <div class="input-group">
            <label>의식:</label>
            <select class="party-ritual" style="width: 50px;">
              <option value="0" selected>0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div class="input-group">
            <label>순서:</label>
            <select class="party-order" style="width: 50px;">
              <option value="-" selected>-</option>
            </select>
          </div>
          <div class="input-group">
            <label>주 계시:</label>
            <select class="main-revelation">
              <option value="">-</option>
            </select>
          </div>
          <div class="input-group">
            <label>일월성진:</label>
            <select class="sub-revelation" disabled>
              <option value="">-</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 파티 이미지를 위한 컨테이너 -->
    <div class = "middle-contianer">
      <div class="party-images-container">
        <div class="party-images"></div>
      </div>
      <div class="madeby">absolroot.github.io/p5x-tactic by 루트</div>
    </div>

    <!-- 턴 영역 (6턴) -->
    <div id="turns"></div>
    
    <!-- SortableJS (드래그앤드롭 라이브러리) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
      /* ========== 전역 데이터 ========== */
      // 원더의 페르소나 3칸
      let wonderPersonas = ["","",""];
      
      // 파티원 정보 (5명)
      let partyMembers = [
        { index: 0, name: "원더", order: "1", ritual: "" },
        { index: 1, name: "", order: "2", ritual: "" },
        { index: 2, name: "", order: "3", ritual: "" },
        { index: 3, name: "", order: "4", ritual: "" },
        { index: 4, name: "", order: "-", ritual: "" }
      ];
      
      // 턴 데이터(6턴). 각 턴에는 actions 배열(자동+수동 구분)만 둔다.
      let turns = [];
      for (let i = 0; i < 6; i++) {
        turns.push({
          turn: i + 1,
          actions: [
            /* 예: { type: 'auto', character: '원더', action: '', wonderPersona: '' } */
          ]
        });
      }


      
      // DOM이 로드되면 초기 설정
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const sharedData = urlParams.get('data');
        
        if (sharedData) {
          const decodedData = processSharedData(sharedData);
          if (decodedData) {
            // 제목 설정 추가
            document.querySelector('.title-input').value = decodedData.title;
            
            // 원더 페르소나 데이터 설정
            wonderPersonas = decodedData.w;
            
            // 원더 설정 UI 업데이트
            const wonderInputs = document.querySelectorAll(".wonder-persona-input");
            wonderInputs.forEach((input, idx) => {
              input.value = wonderPersonas[idx] || "";
            });

            // 원더 무기 설정
            document.querySelector(".wonder-weapon-input").value = decodedData.weapon;

            // 페르소나 스킬 설정
            const skillInputs = document.querySelectorAll(".persona-skill-input");
            decodedData.personaSkills.forEach((skill, idx) => {
              if (skillInputs[idx]) skillInputs[idx].value = skill;
            });
            
            // partyMembers 데이터 복원
            decodedData.p.forEach((p, idx) => {
              partyMembers[idx].name = p.name;
              partyMembers[idx].order = p.order;
              partyMembers[idx].ritual = p.ritual;
              
              // 파티원 이름 입력 필드 업데이트
              const partyDiv = document.querySelector(`.party-member[data-index="${idx}"]`);
              if (partyDiv) {
                const nameInput = partyDiv.querySelector(".party-name-input");
                const orderSelect = partyDiv.querySelector(".party-order");
                const ritualSelect = partyDiv.querySelector(".party-ritual");
                const mainRevSelect = partyDiv.querySelector(".main-revelation");
                const subRevSelect = partyDiv.querySelector(".sub-revelation");
                
                if (nameInput) nameInput.value = p.name || "";
                if (orderSelect) orderSelect.value = p.order || "";
                if (ritualSelect) ritualSelect.value = p.ritual || "0";
                
                // 계시 설정
                if (mainRevSelect && p.mainRev) {
                  mainRevSelect.value = p.mainRev;
                  // 주 계시가 선택되었을 때 일월성진 활성화
                  if (p.mainRev && revelationData.main[p.mainRev]) {
                    subRevSelect.disabled = false;
                    // 일월성진 옵션 설정
                    subRevSelect.innerHTML = '<option value="">-</option>';
                    revelationData.main[p.mainRev].forEach(subRev => {
                      const opt = document.createElement("option");
                      opt.value = subRev;
                      opt.textContent = subRev;
                      subRevSelect.appendChild(opt);
                    });
                    // 일월성진 값 설정
                    if (p.subRev) {
                      subRevSelect.value = p.subRev;
                    }
                  }
                }
                
                // 원더일 경우 의식과 계시 비활성화
                if (p.n === "원더") {
                  if (ritualSelect) {
                    ritualSelect.disabled = true;
                    ritualSelect.value = "0";
                  }
                  if (mainRevSelect) mainRevSelect.disabled = true;
                  if (subRevSelect) subRevSelect.disabled = true;
                }
              }
            });
            
            // 턴 데이터 복원
            turns = decodedData.t;
            
            // UI 기본 설정
            setupWonderConfig();
            setupPartySelection();

            // 계시값 재설정
            decodedData.p.forEach((p, idx) => {
              const partyDiv = document.querySelector(`.party-member[data-index="${idx}"]`);
              if (partyDiv && p.mainRev) {
                const mainRevSelect = partyDiv.querySelector(".main-revelation");
                const subRevSelect = partyDiv.querySelector(".sub-revelation");
                
                if (mainRevSelect) {
                  mainRevSelect.value = p.mainRev;
                  
                  if (revelationData.main[p.mainRev]) {
                    subRevSelect.disabled = false;
                    subRevSelect.innerHTML = '<option value="">-</option>';
                    revelationData.main[p.mainRev].forEach(subRev => {
                      const opt = document.createElement("option");
                      opt.value = subRev;
                      opt.textContent = subRev;
                      subRevSelect.appendChild(opt);
                    });
                    
                    if (p.subRev) {
                      subRevSelect.value = p.subRev;
                    }
                  }
                }
              }
            });

            updatePartyImages();
            
            // 턴 렌더링 (자동 액션 업데이트 전)
            renderTurns();
            
            // 각 턴의 액션 데이터 복원
            turns.forEach((turn, turnIndex) => {
              const turnContainer = document.querySelector(`.turn-container[data-turn-index="${turnIndex}"]`);
              if (!turnContainer) return;

              const actionsList = turnContainer.querySelector('.actions');
              if (!actionsList) return;

              turn.actions.forEach((action, actionIndex) => {
                const actionItem = actionsList.children[actionIndex];
                if (!actionItem) return;

                // 캐릭터 선택
                const charSelect = actionItem.querySelector('.action-character');
                if (charSelect) {
                  charSelect.value = action.character;
                }

                // 원더 페르소나 또는 스킬 선택
                if (action.character === "원더") {
                  const personaSelect = actionItem.querySelector('.wonder-persona-select');
                  if (personaSelect) {
                    personaSelect.value = action.wonderPersona;
                  }
                } else {
                  const skillSelect = actionItem.querySelector('.action-skill');
                  if (skillSelect) {
                    skillSelect.value = action.action;
                  }
                }

                // 메모 입력
                const memoInput = actionItem.querySelector('.action-memo');
                if (memoInput) {
                  memoInput.value = action.memo || "";
                }
              });
            });
            
            // 마지막으로 자동 액션 업데이트
            updateAutoActions();
            
          } 
        } else {
          setupWonderConfig();
          setupPartySelection();
          updateAutoActions();
          updatePartyImages();
          renderTurns();
        }
      });


      // 기본 URL 함수
      function getBaseUrl() {
        // 현재 페이지의 기본 URL을 반환 (쿼리 파라미터 제외)
        return window.location.href.split('?')[0];
      }


      // UI 토글 함수
      function toggleUI() {
        const container = document.querySelector('.container');
        const toggleBtn = document.querySelector('.toggle-ui-btn');
        
        container.classList.toggle('hide-ui');
        toggleBtn.classList.toggle('active');
        
        // 토글 상태 저장
        localStorage.setItem('uiHidden', container.classList.contains('hide-ui'));
      }

      // 페이지 로드 시 이전 상태 복원
      document.addEventListener('DOMContentLoaded', () => {
        const uiHidden = localStorage.getItem('uiHidden') === 'true';
        const toggleBtn = document.querySelector('.toggle-ui-btn');
        
        if (uiHidden) {
          document.querySelector('.container').classList.add('hide-ui');
          toggleBtn.classList.add('active');
        }
      });

    </script>
  </div>
</body>
</html>
